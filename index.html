<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Editor v4.5 (External Preview)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --border-color: #3e3e42;
            --highlight-bg: #f1c40f;
            --tab-inactive-bg: #2d2d2d;
            --tab-active-bg: #1e1e1e;
            --icon-color: #cccccc;
            --danger-color: #d32f2f;
            --success-color: #388e3c;
            --console-bg: #0c0c0c;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Zen Mode (UI Hidden) --- */
        body.zen-mode header,
        body.zen-mode .file-tab-bar {
            display: none !important;
        }

        /* --- SVG Icons --- */
        .icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
            vertical-align: middle;
        }

        /* --- File Tabs --- */
        .file-tab-bar {
            background-color: var(--sidebar-bg);
            display: flex;
            align-items: center;
            overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
            height: 35px;
            flex-shrink: 0;
        }
        
        .file-tab {
            padding: 0 10px;
            height: 100%;
            display: flex;
            align-items: center;
            background-color: var(--tab-inactive-bg);
            color: #888;
            border-right: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 0.85rem;
            min-width: 100px;
            justify-content: space-between;
            user-select: none;
            transition: background-color 0.2s;
        }

        /* Drag & Drop Styles */
        .file-tab.dragging {
            opacity: 0.5;
            background-color: #444;
        }
        .file-tab.drag-over {
            border-left: 2px solid var(--accent-color);
        }

        .file-tab.active {
            background-color: var(--tab-active-bg);
            color: var(--text-color);
            border-top: 2px solid var(--accent-color);
        }

        /* Visual feedback for long press */
        .file-tab.pressing {
            background-color: #444;
        }

        .file-tab-close {
            margin-left: 8px;
            border-radius: 50%;
            padding: 2px;
            font-size: 12px;
            line-height: 1;
            opacity: 0.7;
        }
        .file-tab-close:hover { background-color: #444; opacity: 1; }

        .add-tab-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0 10px;
            cursor: pointer;
        }
        .add-tab-btn:hover { color: white; }

        /* --- Header & View Mode Tabs --- */
        header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            padding: 0 10px;
            flex-shrink: 0;
        }

        .view-controls {
            display: flex;
            height: 100%;
        }

        .view-tab {
            padding: 0 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: #888;
            font-size: 0.85rem;
            border-bottom: 2px solid transparent;
            height: 100%;
        }

        .view-tab.active {
            color: var(--text-color);
            border-bottom-color: var(--accent-color);
            font-weight: bold;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
        }

        /* --- Main Layout --- */
        .main-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- View Sections --- */
        .view-section {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        .view-section.active { display: flex; }

        /* --- Editor Area --- */
        .editor-wrapper {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        /* Line Numbers */
        .line-numbers {
            width: 45px;
            background-color: var(--bg-color);
            color: #6e7681;
            text-align: right;
            padding: 10px 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            border-right: 1px solid var(--border-color);
            user-select: none;
            overflow: hidden;
            flex-shrink: 0;
            z-index: 5;
        }

        /* Code Container */
        .code-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .code-font-style {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 10px;
            margin: 0;
            white-space: pre;
            overflow-wrap: normal;
            word-wrap: normal;
        }

        /* Smart Indent Overlay */
        .indent-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Scrolls with content */
            z-index: 1;
            pointer-events: none;
            padding: 10px; /* Match editor padding */
            overflow: hidden;
            /* JavaScript handles scroll sync */
        }

        .indent-row {
            height: 21px;
            /* 14px font * 1.5 line-height = 21px */
            display: flex;
            align-items: center;
        }

        .indent-marker {
            width: 2ch;
            /* Assuming 2 space indentation */
            height: 100%;
            border-right: 1px dashed rgba(255, 255, 255, 0.25);
            flex-shrink: 0;
        }

        /* Backdrop (Syntax Highlight) */
        .backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
            overflow: hidden;
            color: var(--text-color);
        }
        
        /* Prism overrides */
        pre[class*="language-"] { margin: 0;
            padding: 0; background: transparent; overflow: visible; }
        code[class*="language-"] { white-space: pre; }

        /* --- 修正: 検索ハイライトの視認性向上 --- */
        .backdrop mark {
            background-color: rgba(255, 215, 0, 0.4);
            color: inherit;
            border-radius: 2px;
        }
        .backdrop mark.current {
            background-color: #ff8c00;
            color: white;
            border: 1px solid orange;
        }

        /* Textarea (Overlay) */
        textarea#codeEditor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            color: transparent;
            caret-color: white; 
            border: none;
            resize: none;
            outline: none;
            z-index: 3;
            overflow: auto;
        }
        
        /* Ensure selection is visible even with transparent text */
        textarea#codeEditor::selection {
            background-color: rgba(38, 79, 120, 0.5);
            color: transparent;
        }

        /* Toolbar */
        .toolbar {
            padding: 6px 10px;
            background-color: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            align-items: center;
            height: 40px;
        }

        /* --- Preview Section --- */
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
            flex: 1;
            /* 新しいタブで開くため、UI上では非表示にする場合もありますが、
               プレビュータブのレイアウト保持のため残しています */
        }
        
        /* Python Console Output (Deprecated in View, used for init logs) */
        #consoleOutput {
            display: none;
            flex: 1;
            background-color: var(--console-bg);
            color: #eee;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-y: auto;
            border: none;
            margin: 0;
        }
        #consoleOutput.error { color: #ff6b6b; }
        .console-loading { color: #aaa; font-style: italic; }

        /* --- Search Box --- */
        .search-panel {
            display: none;
            background: #252526;
            padding: 6px 10px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            gap: 5px;
        }
        .search-panel.active { display: flex; flex-wrap: wrap; }
        
        /* --- Package Manager Box --- */
        .package-panel {
            display: none;
            background: #252526;
            padding: 6px 10px;
            border-bottom: 1px solid var(--border-color);
            flex-direction: column;
            gap: 5px;
            color: #eee;
            font-size: 0.85rem;
            max-height: 250px;
            overflow-y: auto;
        }
        .package-panel.active { display: flex; }
        
        .pkg-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .pkg-list {
            margin-top: 5px;
            border-top: 1px solid var(--border-color);
            padding-top: 5px;
        }
        .pkg-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .pkg-list li {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        .pkg-list li:hover { background: #333; }

        /* --- Sidebar (History & Trash) --- */
        .history-sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: -2px 0 5px rgba(0,0,0,0.5);
        }
        .history-sidebar.open { transform: translateX(0); }

        .history-controls {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Trash/History Tabs */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 5px;
        }
        .sidebar-tab {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            cursor: pointer;
            font-size: 0.85rem;
            color: #888;
            background: #2d2d2d;
        }
        .sidebar-tab.active {
            background: var(--sidebar-bg);
            color: var(--text-color);
            border-top: 2px solid var(--accent-color);
            font-weight: bold;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .history-item:hover { background-color: #37373d; }
        .history-item.pinned { border-left: 3px solid var(--accent-color); background-color: #2d2d30; }
        .history-title { font-weight: bold; margin-bottom: 4px; display: block; font-size: 0.9rem;}
        .history-meta { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; align-items: center; }

        /* --- UI Elements --- */
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.secondary { background-color: #444; }
        button.danger { background-color: var(--danger-color); }
        button.success { background-color: var(--success-color); }
        
        button.icon-btn { padding: 4px; background: transparent; color: #aaa; border: 1px solid transparent; }
        button.icon-btn:hover { color: white; background-color: #444; border-color: #555; }
        button.icon-btn.active { color: var(--highlight-bg); }

        .sep { width: 1px; height: 20px; background: #555; margin: 0 5px; }

        input, select {
            padding: 4px 6px;
            border-radius: 3px;
            border: 1px solid #555;
            background: #3c3c3c;
            color: white;
            font-size: 0.85rem;
        }
        input:focus { border-color: var(--accent-color); outline: none; }
        
        .mode-indicator { font-size: 0.75rem; margin-right: 10px; font-weight: bold; padding: 2px 5px; border-radius: 3px;}
        .mode-html { color: #e34c26; border: 1px solid #e34c26; }
        .mode-python { color: #3572A5; border: 1px solid #3572A5; }

        /* --- Home Screen --- */
        #homeScreen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            overflow-y: auto;
        }

        .home-container {
            max-width: 900px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .home-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .home-actions {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .home-actions button {
            font-size: 1.1rem;
            padding: 10px 20px;
        }

        .home-lists {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .home-lists { grid-template-columns: 1fr; }
        }

        .home-card {
            background: var(--sidebar-bg);
            border-radius: 5px;
            border: 1px solid var(--border-color);
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .home-card h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .home-file-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }
        
        /* New style for external preview hint */
        .preview-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888;
            background: #f9f9f9;
        }
    </style>
</head>
<body>

<div id="homeScreen">
    <div class="home-container">
        <div class="home-header">
            <h1>Advanced Editor v4.5</h1>
            <p style="color:#888;">HTML / Python Web Editor with Persistence</p>
        </div>

        <div class="home-actions">
            <button onclick="createNewFileFlow()" class="success">
                <svg class="icon" viewBox="0 0 24 24" style="margin-right:8px;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                新規ファイル作成
            </button>
        </div>

        <div class="home-lists">
            <div class="home-card">
                <h3>
                    最近使用したファイル
                    <button class="secondary" onclick="deleteAllFromHome('history')" style="font-size:0.7rem;">一括削除</button>
                </h3>
                <ul id="homeHistoryList" class="home-file-list">
                    </ul>
            </div>

            <div class="home-card">
                <h3>
                    ゴミ箱
                    <button class="danger" onclick="deleteAllFromHome('trash')" style="font-size:0.7rem;">ゴミ箱を空にする</button>
                </h3>
                <ul id="homeTrashList" class="home-file-list">
                     </ul>
            </div>
        </div>
    </div>
</div>

<div class="file-tab-bar" id="fileTabBar">
    <button class="add-tab-btn" onclick="createNewFileFlow()" title="新しいファイル">+</button>
</div>

<header>
    <div class="view-controls">
        <button onclick="showHome()" class="secondary" style="margin-right:10px;">
            <svg class="icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            ホーム
        </button>
        <div class="view-tab active" id="tabCode" onclick="switchView('code')">
            コード編集
        </div>
        <div class="view-tab" id="tabPreview" onclick="switchView('preview')">
            実行 / プレビュー (Ctrl+Enter)
        </div>
    </div>
    <div class="header-controls">
        <button onclick="toggleSidebar()" class="secondary toggle-sidebar-btn">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            履歴・ゴミ箱
        </button>
    </div>
</header>

<div class="main-container">

    <div id="viewCode" class="view-section active">
        <div class="toolbar">
            <span id="currentModeLabel" class="mode-indicator mode-html">HTML</span>

            <button onclick="undo()" class="secondary" title="戻す (Ctrl+Z)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
            </button>
            <button onclick="redo()" class="secondary" title="進める (Ctrl+Y)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
            </button>
            
            <div class="sep"></div>

            <button onclick="toggleSearchPanel()" class="secondary" title="検索 (Ctrl+F)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                検索
            </button>
            
            <div id="pythonControls" style="display:none; gap:8px;">
                <div class="sep"></div>
                <button onclick="togglePackagePanel()" class="secondary" title="ライブラリ管理">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>
                    Pip
                </button>
            </div>

            <div style="flex:1;"></div>
            <select id="downloadFormat">
                <option value="html">.html</option>
                <option value="txt">.txt</option>
                <option value="py">.py</option>
            </select>
            <button onclick="downloadCode()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                DL
            </button>
        </div>

        <div id="searchPanel" class="search-panel">
            <input type="text" id="searchInput" placeholder="検索文字列" oninput="highlightSearch()">
            
            <span id="searchStats" style="font-size: 0.8rem; color: #ccc; margin: 0 5px; min-width: 40px; text-align: center;"></span>

            <button onclick="findNext()" class="icon-btn" title="次へ">
                <svg class="icon" viewBox="0 0 24 24"><path d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"/></svg>
            </button>
            <div class="sep"></div>
            <input type="text" id="replaceInput" placeholder="置換文字列">
            <button onclick="doReplace()" class="secondary">置換</button>
            <button onclick="doReplaceAll()" class="secondary">全置換</button>
        </div>

        <div id="packagePanel" class="package-panel">
            <div class="pkg-controls">
                <span><b>Micropip パッケージ管理</b></span>
                <input type="text" id="pkgNameInput" placeholder="パッケージ名 (例: numpy)">
                <button onclick="installPackage()" class="success">インストール</button>
                <div class="sep"></div>
                <button onclick="listPackages()" class="secondary" title="インストール済み一覧を表示">一覧更新</button>
                <button onclick="resetPython()" class="danger">環境リセット</button>
            </div>
            <div id="pkgList" class="pkg-list">
                <div style="text-align:center; color:#888; padding:10px;">「一覧更新」を押してパッケージを表示</div>
            </div>
        </div>

        <div class="editor-wrapper">
            <div class="line-numbers" id="lineNumbers">1</div>
            <div class="code-container" id="codeContainer">
                <div class="indent-overlay" id="indentOverlay"></div>
                <div class="backdrop code-font-style" id="codeBackdrop"></div>
                <textarea id="codeEditor" class="code-font-style" spellcheck="false" placeholder="ここにコードを入力..."></textarea>
            </div>
        </div>
    </div>

    <div id="viewPreview" class="view-section">
        <div class="toolbar" style="background: #f0f0f0; border-bottom: 1px solid #ccc; color: #333;">
            <strong id="previewTitle">Preview Launcher</strong>
            
            <div style="margin-left: auto; display: flex; gap: 5px;">
                <button onclick="toggleZenMode()" class="secondary" title="ヘッダーやタブを非表示">
                   <svg class="icon" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg> UI切替
                </button>
                <button onclick="updatePreview()" class="success" style="color:white;">
                    <svg class="icon" viewBox="0 0 24 24" style="fill:white;"><path d="M8 5v14l11-7z"/></svg>
                    実行/更新 (Ctrl+Enter)
                </button>
            </div>
        </div>
        
        <div class="preview-placeholder">
            <svg class="icon" viewBox="0 0 24 24" style="width:64px; height:64px; color:#ccc; margin-bottom:20px;">
                <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
            </svg>
            <p>結果は新しいタブ（ウィンドウ）で表示されます。</p>
            <p>右上の「実行/更新」ボタンを押すか、<b>Ctrl + Enter</b> キーを押してください。</p>
        </div>
        
        <iframe id="previewFrame" style="display:none;"></iframe>
        <pre id="consoleOutput">Python環境を準備中...</pre>
    </div>

</div>

<div id="historySidebar" class="history-sidebar">
    <div class="sidebar-tabs">
        <div class="sidebar-tab active" id="tabHistory" onclick="switchSidebarTab('history')">履歴</div>
        <div class="sidebar-tab" id="tabTrash" onclick="switchSidebarTab('trash')">ゴミ箱</div>
    </div>
    
    <div class="history-controls">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong id="sidebarTitle">履歴管理</strong>
            <button onclick="toggleSidebar()" class="icon-btn toggle-sidebar-btn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <input type="text" id="historySearch" placeholder="検索..." oninput="renderSidebarContent()">
        <select id="historySort" onchange="renderSidebarContent()">
            <option value="dateDesc">新しい順</option>
            <option value="dateAsc">古い順</option>
            <option value="nameAsc">名前 (A-Z)</option>
        </select>
        <button id="deleteAllBtn" onclick="deleteAllItems()" class="danger" style="margin-top:5px; width:100%; justify-content:center;">一括削除</button>
    </div>
    <ul id="historyList" class="history-list">
    </ul>
</div>

<script>
    // --- Initial Config & Data ---
    // (Deprecated defaultHtml - keeping variable to prevent errors but it's empty now)
    const defaultHtml = ""; 

    // Elements
    const codeEditor = document.getElementById('codeEditor');
    const codeBackdrop = document.getElementById('codeBackdrop');
    const lineNumbers = document.getElementById('lineNumbers');
    const indentOverlay = document.getElementById('indentOverlay');
    const previewFrame = document.getElementById('previewFrame');
    const consoleOutput = document.getElementById('consoleOutput');
    const fileTabBar = document.getElementById('fileTabBar');
    const homeScreen = document.getElementById('homeScreen');
    
    // Pyodide State
    let pyodide = null;
    let pyodideReady = false;

    // State
    let searchMatches = [];
    let currentMatchIndex = -1;
    let files = [];
    let activeFileId = null;
    let currentSidebarMode = 'history';

    // Constants
    const HISTORY_KEY = 'htmlEditorV4_History';
    const TRASH_KEY = 'htmlEditorV4_Trash';
    const PKG_KEY = 'htmlEditorV4_InstalledPkgs';

    // --- Window Load & Pyodide Init ---
    window.onload = async () => {
        cleanupTrash();
        // Show Home instead of creating default file
        showHome();
        // Pyodide Load
        try {
            consoleOutput.textContent = "Python環境(Pyodide)をロード中...";
            pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");
            pyodideReady = true;
            consoleOutput.textContent = "Python環境の準備完了。";
            // Restore installed packages
            await restorePackages();

            console.log("Pyodide Ready");
        } catch (e) {
            consoleOutput.textContent = "Python環境のロードに失敗しました。\n" + e;
        }

        // Sidebar click handler
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('historySidebar');
            if (sidebar.classList.contains('open') && 
                !sidebar.contains(e.target) && 
                !e.target.closest('.toggle-sidebar-btn')) {
                toggleSidebar();
            }
        });
    };

    // --- Home Screen Logic ---
    function showHome() {
        homeScreen.style.display = 'flex';
        // Hide editor UI
        document.querySelector('header').style.display = 'none';
        document.querySelector('.file-tab-bar').style.display = 'none';
        document.querySelector('.main-container').style.display = 'none';
        renderHomeLists();
    }

    function hideHome() {
        homeScreen.style.display = 'none';
        document.querySelector('header').style.display = 'flex';
        document.querySelector('.file-tab-bar').style.display = 'flex';
        document.querySelector('.main-container').style.display = 'flex';
    }

    function renderHomeLists() {
        const historyList = document.getElementById('homeHistoryList');
        const trashList = document.getElementById('homeTrashList');
        
        // Render History
        const historyData = getStorageData(HISTORY_KEY);
        // Sort by date desc
        historyData.sort((a, b) => new Date(b.date) - new Date(a.date));
        historyList.innerHTML = '';
        if (historyData.length === 0) {
            historyList.innerHTML = '<li style="padding:10px; color:#666; text-align:center;">履歴はありません</li>';
        } else {
            historyData.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';

                const dateStr = new Date(item.date).toLocaleString('ja-JP', { month: '2-digit', day: '2-digit', hour:'2-digit', minute:'2-digit' });
                
                li.innerHTML = `
                    <div onclick="openFileFromHome(${item.id})" style="cursor:pointer; flex:1;">
                        <span style="font-weight:bold; display:block;">${escapeHtml(item.title)}</span>
                        <span style="font-size:0.75rem; color:#888;">${dateStr}</span>
                    </div>
                    <div>
                        <button class="icon-btn" onclick="renameHistoryItem(${item.id}); renderHomeLists();" title="名前変更">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        </button>
                        <button class="icon-btn danger" onclick="softDeleteHistory(${item.id}); renderHomeLists();" title="削除">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                `;
                historyList.appendChild(li);
            });
        }

        // Render Trash
        const trashData = getStorageData(TRASH_KEY);
        trashData.sort((a, b) => b.deletedAt - a.deletedAt);
        
        trashList.innerHTML = '';
        if (trashData.length === 0) {
            trashList.innerHTML = '<li style="padding:10px; color:#666; text-align:center;">ゴミ箱は空です</li>';
        } else {
            trashData.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                
                li.innerHTML = `
                    <div style="flex:1;">
                        <span style="font-weight:bold; display:block;">${escapeHtml(item.title)}</span>
                        <span style="font-size:0.75rem; color:#888;">削除待機中</span>
                    </div>
                    <div>
                        <button class="icon-btn success" onclick="restoreTrashItem(${item.id}); renderHomeLists();" title="復元">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M14 12c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zm-2-9c-4.97 0-9 4.03-9 9H0l4 4 4-4H5c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.51 0-2.91-.49-4.06-1.3l-1.42 1.44C8.04 20.3 9.94 21 12 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>
                        </button>
                        <button class="icon-btn danger" onclick="permDeleteTrashItem(${item.id}); renderHomeLists();" title="完全削除">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                `;
                trashList.appendChild(li);
            });
        }
    }

    // --- Validation Helper ---
    function isValidExtension(name) {
        return name.endsWith('.html') || name.endsWith('.py');
    }

    function createNewFileFlow() {
        // Prompt for filename FIRST
        let name = prompt("新規ファイル名を入力してください (例: script.py, index.html):", "untitled.html");
        if (name === null) return; // Cancelled
        if (name.trim() === "") name = "untitled.html";
        
        // Extension Check
        if (!isValidExtension(name)) {
            alert("拡張子は .html または .py のみ許可されています。");
            return;
        }

        hideHome();
        
        // Start with empty content
        let content = '';
        addNewFile(name, content);
    }

    function openFileFromHome(dbId) {
        hideHome();
        loadHistoryItem(dbId, false);
    }

    function deleteAllFromHome(type) {
        if (type === 'trash') {
            if(!confirm("ゴミ箱を完全に空にしますか？")) return;
            setStorageData(TRASH_KEY, []);
        } else {
            if(!confirm("履歴をすべてゴミ箱へ移動しますか？")) return;
            let history = getStorageData(HISTORY_KEY);
            let trash = getStorageData(TRASH_KEY);
            
            history.forEach(item => {
                item.deletedAt = Date.now();
                item.pinned = false;
            });
            setStorageData(HISTORY_KEY, []);
            setStorageData(TRASH_KEY, [...history, ...trash]);
        }
        renderHomeLists();
    }

    // --- Keyboard Shortcuts ---
    document.addEventListener('keydown', (e) => {
        const ctrl = e.ctrlKey || e.metaKey;

        if (ctrl) {
            switch(e.key.toLowerCase()) {
                case 's': // Save
                    e.preventDefault();
                    console.log("Auto-saved");
                    break;
                case 'f': // Find
                    e.preventDefault();
                    if(homeScreen.style.display !== 'none') return;
                    toggleSearchPanel();
                    break;
                case 'enter': // Preview / Run
                    e.preventDefault();
                    if(homeScreen.style.display !== 'none') return;
                    if (document.getElementById('tabCode').classList.contains('active')) {
                        switchView('preview');
                    } else {
                        updatePreview();
                    }
                    break;
                case 'z': // Undo
                    e.preventDefault();
                    if(homeScreen.style.display !== 'none') return;
                    if (e.shiftKey) redo(); else undo();
                    break;
                case 'y': // Redo
                    e.preventDefault();
                    if(homeScreen.style.display !== 'none') return;
                    redo();
                    break;
            }
        }
    });

    // --- File Tabs Logic & Undo Stack ---
    function addNewFile(name, content, dbId = null) {
        const id = Date.now().toString() + Math.random().toString(16).slice(2);
        const fileContent = content !== undefined ? content : '';
        
        let historyId = dbId;
        if (!historyId) {
            historyId = createInitialHistory(name, fileContent);
        }

        files.push({ 
            id, 
            dbId: historyId, 
            name: name, 
            content: fileContent,
            history: [fileContent],
            historyIndex: 0    
        });

        switchFile(id);
    }

    function switchFile(id) {
        if (activeFileId) {
            const currentFile = files.find(f => f.id === activeFileId);
            if (currentFile) {
                currentFile.content = codeEditor.value;
            }
        }

        activeFileId = id;
        const file = files.find(f => f.id === activeFileId);
        
        codeEditor.value = file ? file.content : '';
        // Mode detection
        updateEditorMode(file ? file.name : '');

        document.getElementById('searchInput').value = '';
        highlightSearch();
        updateLineNumbers();
        updateIndentGuides(); // Trigger indent update

        // プレビュータブにいても、実行はボタンを押したときのみにするため
        // ここでのupdatePreview呼び出しは削除しました
        
        renderFileTabs();
    }

    function updateEditorMode(filename) {
        const label = document.getElementById('currentModeLabel');
        const pyControls = document.getElementById('pythonControls');
        const dlSelect = document.getElementById('downloadFormat');

        if (filename.endsWith('.py')) {
            label.textContent = 'PYTHON';
            label.className = 'mode-indicator mode-python';
            pyControls.style.display = 'flex';
            dlSelect.value = 'py';
        } else {
            label.textContent = 'HTML';
            label.className = 'mode-indicator mode-html';
            pyControls.style.display = 'none';
            dlSelect.value = 'html';
        }
    }

    function closeFile(e, id) {
        e.stopPropagation();
        const index = files.findIndex(f => f.id === id);
        files.splice(index, 1);
        if (files.length === 0) {
            // If all files closed, go to Home
            showHome();
            activeFileId = null;
            return;
        }

        if (id === activeFileId) {
            const nextFile = files[index] || files[index - 1];
            switchFile(nextFile.id);
        } else {
            renderFileTabs();
        }
    }

    // Rename triggered from Tab
    function renameFile(id) {
        const file = files.find(f => f.id === id);
        if(!file) return;
        const newName = prompt("ファイル名を変更 (拡張子 .py でPythonモード):", file.name);
        if(newName && newName.trim() !== "") {
            // Extension Check
            if (!isValidExtension(newName)) {
                alert("拡張子は .html または .py のみ許可されています。");
                return;
            }

            file.name = newName;
            renderFileTabs();
            updateHistoryTitle(file.dbId, newName);
            // Re-check mode if extension changed
            if (id === activeFileId) updateEditorMode(newName);
        }
    }

    // Helper for Long Press Detection
    function addLongPressEvent(element, callback) {
        let timer;
        const delay = 800; // 0.8s for long press

        const start = (e) => {
            if (e.type === 'mousedown' && e.button !== 0) return;
            element.classList.add('pressing');
            timer = setTimeout(() => {
                element.classList.remove('pressing');
                callback(e);
            }, delay);
        };

        const cancel = () => {
            if (timer) {
                clearTimeout(timer);
                element.classList.remove('pressing');
            }
        };

        element.addEventListener('mousedown', start);
        element.addEventListener('touchstart', start, {passive: true});
        
        element.addEventListener('mouseup', cancel);
        element.addEventListener('mouseleave', cancel);
        element.addEventListener('touchend', cancel);
        element.addEventListener('touchmove', cancel);

        element.cancelLongPress = cancel;
    }

    // --- Tab Drag & Drop Logic ---
    let draggedTabId = null;
    function handleTabDragStart(e, id) {
        draggedTabId = id;
        e.dataTransfer.effectAllowed = 'move';
        e.target.classList.add('dragging');
        if (e.target.cancelLongPress) {
            e.target.cancelLongPress();
        }
    }

    function handleTabDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const target = e.target.closest('.file-tab');
        if (target) {
            document.querySelectorAll('.file-tab').forEach(t => t.classList.remove('drag-over'));
            target.classList.add('drag-over');
        }
    }

    function handleTabDrop(e, targetId) {
        e.preventDefault();
        document.querySelectorAll('.file-tab').forEach(t => {
            t.classList.remove('dragging');
            t.classList.remove('drag-over');
        });
        if (draggedTabId === targetId) return;

        const fromIndex = files.findIndex(f => f.id === draggedTabId);
        const toIndex = files.findIndex(f => f.id === targetId);

        if (fromIndex >= 0 && toIndex >= 0) {
            const movedFile = files.splice(fromIndex, 1)[0];
            files.splice(toIndex, 0, movedFile);
            renderFileTabs();
        }
        draggedTabId = null;
    }

    function handleTabDragEnd(e) {
        document.querySelectorAll('.file-tab').forEach(t => {
            t.classList.remove('dragging');
            t.classList.remove('drag-over');
        });
        draggedTabId = null;
    }

    // --- Mobile Touch Drag Logic ---
    function handleTouchDragStart(e, id) {
        draggedTabId = id;
        e.target.closest('.file-tab').classList.add('dragging');
    }

    function handleTouchDragMove(e) {
        if (!draggedTabId) return;
        e.preventDefault();
        // Stop scroll
        
        const touch = e.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const tab = target?.closest('.file-tab');

        document.querySelectorAll('.file-tab').forEach(t => t.classList.remove('drag-over'));
        if (tab && tab.dataset.id !== draggedTabId) {
            tab.classList.add('drag-over');
        }
    }

    function handleTouchDragEnd(e) {
        if (!draggedTabId) return;
        const touch = e.changedTouches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const targetTab = target?.closest('.file-tab');
        const targetId = targetTab?.dataset.id;
        document.querySelectorAll('.file-tab').forEach(t => {
            t.classList.remove('dragging');
            t.classList.remove('drag-over');
        });
        if (targetId && draggedTabId !== targetId) {
            const fromIndex = files.findIndex(f => f.id === draggedTabId);
            const toIndex = files.findIndex(f => f.id === targetId);

            if (fromIndex >= 0 && toIndex >= 0) {
                const movedFile = files.splice(fromIndex, 1)[0];
                files.splice(toIndex, 0, movedFile);
                renderFileTabs();
            }
        }
        draggedTabId = null;
    }

    function renderFileTabs() {
        const addBtn = fileTabBar.querySelector('.add-tab-btn');
        fileTabBar.innerHTML = '';
        
        files.forEach(file => {
            const div = document.createElement('div');
            div.className = `file-tab ${file.id === activeFileId ? 'active' : ''}`;
            div.title = "ダブルクリック/長押し/右クリックで名前変更、ドラッグで並べ替え";
            div.dataset.id = file.id; // For Touch Drag Identification

            // Drag attributes (Desktop)
            div.draggable = true;
            div.ondragstart = (e) => handleTabDragStart(e, file.id);
            div.ondragover = (e) => handleTabDragOver(e);
            div.ondrop = (e) => handleTabDrop(e, file.id);
            div.ondragend = (e) => handleTabDragEnd(e);

            // Drag attributes (Mobile)
            div.addEventListener('touchstart', (e) => handleTouchDragStart(e, file.id), {passive: true});
            div.addEventListener('touchmove', handleTouchDragMove, {passive: false});
            div.addEventListener('touchend', handleTouchDragEnd);

            // Click to switch
            div.onclick = () => switchFile(file.id);
        
            // Double Click Rename
            div.ondblclick = () => renameFile(file.id);
            
            // Right Click Rename
            div.oncontextmenu = (e) => {
                e.preventDefault();
                renameFile(file.id);
                return false;
            };

            // Long Press Rename
            addLongPressEvent(div, () => renameFile(file.id));
            div.innerHTML = `
                <span>${escapeHtml(file.name)}</span>
                <span class="file-tab-close" onclick="closeFile(event, '${file.id}')">✕</span>
            `;
            fileTabBar.appendChild(div);
        });
        fileTabBar.appendChild(addBtn);
    }

    // --- Undo / Redo ---
    let debounceTimer = null;
    function pushHistory(newContent) {
        const file = files.find(f => f.id === activeFileId);
        if(!file) return;
        if (file.history[file.historyIndex] === newContent) return;

        if (file.historyIndex < file.history.length - 1) {
            file.history = file.history.slice(0, file.historyIndex + 1);
        }

        file.history.push(newContent);
        file.historyIndex++;
        file.content = newContent;
        if (file.history.length > 50) {
            file.history.shift();
            file.historyIndex--;
        }
    }

    function undo() {
        const file = files.find(f => f.id === activeFileId);
        if (!file || file.historyIndex <= 0) return;

        file.historyIndex--;
        const prevContent = file.history[file.historyIndex];
        
        codeEditor.value = prevContent;
        file.content = prevContent;

        updateLineNumbers();
        updateIndentGuides();
        syncBackdrop();
        triggerAutoSave(file.dbId, prevContent);
    }

    function redo() {
        const file = files.find(f => f.id === activeFileId);
        if (!file || file.historyIndex >= file.history.length - 1) return;

        file.historyIndex++;
        const nextContent = file.history[file.historyIndex];
        
        codeEditor.value = nextContent;
        file.content = nextContent;
        updateLineNumbers();
        updateIndentGuides();
        syncBackdrop();
        triggerAutoSave(file.dbId, nextContent);
    }

    // --- View Switching ---
    function switchView(mode) {
        document.getElementById('tabCode').classList.toggle('active', mode === 'code');
        document.getElementById('tabPreview').classList.toggle('active', mode === 'preview');
        
        document.getElementById('viewCode').classList.toggle('active', mode === 'code');
        document.getElementById('viewPreview').classList.toggle('active', mode === 'preview');
    }
    
    function toggleZenMode() {
        document.body.classList.toggle('zen-mode');
    }

    // --- Editor Logic ---
    codeEditor.addEventListener('scroll', () => {
        const top = codeEditor.scrollTop;
        const left = codeEditor.scrollLeft;
        codeBackdrop.scrollTop = top;
        codeBackdrop.scrollLeft = left;
        lineNumbers.scrollTop = top;
        indentOverlay.scrollTop = top;
        indentOverlay.scrollLeft = left;
    });
    let autoSaveDebounce = null;
    codeEditor.addEventListener('input', () => {
        const val = codeEditor.value;
        const file = files.find(f => f.id === activeFileId);
        if(file) {
            file.content = val;
            clearTimeout(autoSaveDebounce);
            autoSaveDebounce = setTimeout(() => {
                updateHistoryContent(file.dbId, val);
            }, 1000);
        }

        updateLineNumbers();
        updateIndentGuides(); // Recalculate guides on input
        syncBackdrop();
        if(document.getElementById('searchInput').value) highlightSearch();

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            pushHistory(val);
        }, 500);
    });

    function triggerAutoSave(dbId, content) {
        clearTimeout(autoSaveDebounce);
        updateHistoryContent(dbId, content);
    }

    codeEditor.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            document.execCommand('insertText', false, "  ");
        }
    });
    function updateLineNumbers() {
        const lines = codeEditor.value.split('\n').length;
        if (lineNumbers.childElementCount !== lines) {
            lineNumbers.innerHTML = Array(lines).fill(0).map((_, i) => `<div>${i + 1}</div>`).join('');
        }
    }

    // --- Smart Indent Guides (修正版) ---
    function updateIndentGuides() {
        const code = codeEditor.value;
        const lines = code.split('\n');
        
        // 修正: エディタの内容幅に合わせてコンテナの幅を強制する
        // これにより、横スクロール時にインデントガイドも正しくスクロールされる
        const scrollWidth = codeEditor.scrollWidth;
        let html = `<div style="min-width: ${scrollWidth}px; height: 100%;">`;
        
        const tabSize = 2;
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const leadingSpaces = line.match(/^ */)[0].length;
            
            const guidesCount = Math.floor(leadingSpaces / tabSize);
            let rowHtml = '<div class="indent-row">';
            for(let j = 0; j < guidesCount; j++) {
                rowHtml += '<span class="indent-marker"></span>';
            }
            rowHtml += '</div>';
            html += rowHtml;
        }
        html += '</div>';
        
        indentOverlay.innerHTML = html;
        indentOverlay.scrollTop = codeEditor.scrollTop;
        indentOverlay.scrollLeft = codeEditor.scrollLeft;
    }


    // --- Syntax Highlight & Backdrop ---
    function syncBackdrop() {
        if (document.getElementById('searchInput').value) return;
        let code = codeEditor.value;
        if (code.endsWith("\n")) code += " ";

        const file = files.find(f => f.id === activeFileId);
        const isPython = file && file.name.endsWith('.py');

        const grammar = isPython ? Prism.languages.python : Prism.languages.html;
        const langName = isPython ? 'python' : 'html';

        const highlighted = Prism.highlight(code, grammar, langName);
        codeBackdrop.innerHTML = highlighted;
    }

    // --- Preview & Python Execution (External Window Version) ---
    async function updatePreview() {
        const file = files.find(f => f.id === activeFileId);
        if (!file) return;

        const isPython = file.name.endsWith('.py');
        const prevTitle = document.getElementById('previewTitle');
        
        // Open a new window
        const win = window.open('', '_blank');
        if (!win) {
            alert("ポップアップがブロックされました。ブラウザの設定で許可してください。");
            return;
        }

        if (isPython) {
            prevTitle.textContent = 'Python Running in New Window...';
            
            // Set up basic style for Python console in new window
            win.document.write(`
                <html>
                <head>
                    <title>Python Console Output</title>
                    <style>
                        body { background-color: #0c0c0c; color: #eee; font-family: 'Consolas', 'Monaco', monospace; padding: 20px; }
                        #output { white-space: pre-wrap; font-size: 14px; }
                        .error { color: #ff6b6b; }
                    </style>
                </head>
                <body>
                    <div id="output">Running Python code...</div>
                </body>
                </html>
            `);
            win.document.close();

            if (!pyodideReady) {
                if(win.document.getElementById('output')) 
                    win.document.getElementById('output').textContent = "Python環境をロード中...しばらくお待ちください。";
                return;
            }

            const appendLog = (msg, isError = false) => {
                if (win.closed) return;
                const outDiv = win.document.getElementById('output');
                if (outDiv) {
                    // Initial "Running..." text cleanup on first real log
                    if (outDiv.textContent === 'Running Python code...') outDiv.textContent = '';
                    
                    const span = win.document.createElement('span');
                    if (isError) span.className = 'error';
                    span.textContent = msg + "\n";
                    outDiv.appendChild(span);
                    win.scrollTo(0, win.document.body.scrollHeight);
                }
            };

            appendLog("実行開始...\n");

            try {
                // Redirect Stdout to the new window
                pyodide.setStdout({ batched: (msg) => {
                    appendLog(msg);
                }});

                appendLog("ライブラリの依存関係を確認中...\n");
                await pyodide.loadPackagesFromImports(codeEditor.value, {
                    messageCallback: (msg) => {
                        appendLog(`[Auto-Install] ${msg}`);
                    },
                    errorCallback: (err) => {
                        appendLog(`[Auto-Install Error] ${err}`, true);
                    }
                });

                await pyodide.runPythonAsync(codeEditor.value);
                appendLog("\n--- 実行完了 ---");
            } catch (err) {
                appendLog(`\nError:\n${err}`, true);
            }

        } else {
            // HTML Mode
            prevTitle.textContent = 'HTML Preview Opened';
            
            // Write HTML content directly to the new window
            win.document.open();
            win.document.write(codeEditor.value);
            win.document.close();
        }
    }

    // --- Python Package Management (With Persistence) ---
    function togglePackagePanel() {
        const panel = document.getElementById('packagePanel');
        panel.classList.toggle('active');
        if(panel.classList.contains('active')) {
            listPackages();
        }
    }

    async function restorePackages() {
        // Load persistent packages
        const savedPkgs = getStorageData(PKG_KEY);
        if (savedPkgs.length === 0) return;

        const consoleOut = document.getElementById('consoleOutput');
        consoleOut.textContent += `\nインストール済みパッケージを復元中 (${savedPkgs.length}個)...\n`;
        try {
            const micropip = pyodide.pyimport("micropip");
            for (const pkg of savedPkgs) {
                 await micropip.install(pkg);
                console.log(`Restored package: ${pkg}`);
            }
            consoleOut.textContent += `パッケージの復元が完了しました。\n`;
        } catch (err) {
             consoleOut.textContent += `パッケージ復元中にエラー: ${err}\n`;
        }
    }

    async function installPackage() {
        const input = document.getElementById('pkgNameInput');
        const pkg = input.value.trim();
        if (!pkg || !pyodideReady) return;

        // Install uses the internal console for feedback to avoid opening windows for just installs
        const consoleOut = document.getElementById('consoleOutput');
        // Show console temporarily in sidebar/preview area if needed, 
        // but here we just log to the hidden element or use alert if it fails.
        // Better UX: Show a notification. For now, logging to console log.
        console.log(`Installing ${pkg}...`);

        try {
            const micropip = pyodide.pyimport("micropip");
            await micropip.install(pkg);
            console.log(`Successfully installed ${pkg}!`);
            alert(`${pkg} のインストールが完了しました。`);
            
            // Persist
            const savedPkgs = getStorageData(PKG_KEY);
            if (!savedPkgs.includes(pkg)) {
                savedPkgs.push(pkg);
                setStorageData(PKG_KEY, savedPkgs);
            }

            input.value = '';
            listPackages();
            // refresh list
        } catch (err) {
            console.error(`Installation failed: ${err}`);
            alert(`インストール失敗: ${err}`);
        }
    }

    // JSから呼ばれるコールバック
    function updatePackageListUI(jsonStr) {
        const packages = JSON.parse(jsonStr);
        const listContainer = document.getElementById('pkgList');
        
        if (packages.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#888;">インストール済みパッケージはありません</div>';
            return;
        }

        let html = '<ul>';
        packages.forEach(pkg => {
            html += `
                <li>
                    <span style="font-family:monospace;">${escapeHtml(pkg)}</span>
                    <button class="icon-btn danger" onclick="deletePackage('${escapeHtml(pkg)}')" title="削除 (アンロード)">✕</button>
                </li>
            `;
        });
        html += '</ul>';
        listContainer.innerHTML = html;
    }

    async function listPackages() {
        if (!pyodideReady) return;
        const listContainer = document.getElementById('pkgList');
        listContainer.innerHTML = '<div style="padding:10px; color:#888;">取得中...</div>';

        try {
            await pyodide.runPythonAsync(`
import micropip
import js
import json
try:
    pkgs = list(micropip.list().keys())
    js.updatePackageListUI(json.dumps(pkgs))
except Exception as e:
    print(e)
            `);
        } catch(e) {
            listContainer.innerHTML = '<div style="color:red">一覧の取得に失敗しました</div>';
        }
    }

    async function deletePackage(pkgName) {
        if(!confirm(`${pkgName} を削除（メモリからアンロード）しますか？\n次回起動時にも読み込まれなくなります。`)) return;
        if (!pyodideReady) return;
        
        try {
            // Remove from storage
            let savedPkgs = getStorageData(PKG_KEY);
            savedPkgs = savedPkgs.filter(p => p !== pkgName);
            setStorageData(PKG_KEY, savedPkgs);

            await pyodide.runPythonAsync(`
import sys
import shutil
import pathlib

pkg = "${pkgName}"
if pkg in sys.modules:
    del sys.modules[pkg]
    print(f"Unloaded {pkg} from sys.modules")

paths_to_check = sys.path
for p in paths_to_check:
    target = pathlib.Path(p) / pkg
    if target.exists() and target.is_dir():
        try:
            shutil.rmtree(target)
            print(f"Removed directory: {target}")
        except:
            pass
            `);
            alert(`${pkgName} を削除しました。`);
            listPackages();
        } catch(e) {
            alert("削除中にエラーが発生しました:\n" + e);
        }
    }

    function resetPython() {
        if(!confirm("Python環境をリセット（インストール済みパッケージを全削除）しますか？\nページがリロードされます。")) return;
        setStorageData(PKG_KEY, []);
        location.reload();
    }

    // --- Search Logic ---
    function toggleSearchPanel() {
        const panel = document.getElementById('searchPanel');
        panel.classList.toggle('active');
        if (panel.classList.contains('active')) {
            document.getElementById('searchInput').focus();
        } else {
            document.getElementById('searchInput').value = '';
            // Clear stats
            document.getElementById('searchStats').textContent = '';
            syncBackdrop();
        }
    }

    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function highlightSearch() {
        const term = document.getElementById('searchInput').value;
        const text = codeEditor.value;
        const statsEl = document.getElementById('searchStats');
        
        if (!term) {
            syncBackdrop();
            searchMatches = [];
            statsEl.textContent = '';
            return;
        }

        const escapedTerm = escapeHtml(term);
        const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'); 
        
        let matchCount = 0;
        const highlightedHtml = escapeHtml(text).replace(regex, (match) => {
            matchCount++;
            return `<mark data-index="${matchCount-1}">${match}</mark>`;
        });
        
        codeBackdrop.innerHTML = highlightedHtml + (text.endsWith('\n') ? '<br>&nbsp;' : '');
        codeBackdrop.scrollTop = codeEditor.scrollTop;
        codeBackdrop.scrollLeft = codeEditor.scrollLeft;
        searchMatches = codeBackdrop.querySelectorAll('mark');
        currentMatchIndex = -1;
        // 修正: ヒット数を表示
        if(searchMatches.length > 0) {
            statsEl.textContent = `${searchMatches.length} found`;
        } else {
            statsEl.textContent = `0 found`;
        }
    }

    function findNext() {
        const statsEl = document.getElementById('searchStats');
        if (searchMatches.length === 0) return;
        
        if (currentMatchIndex >= 0 && searchMatches[currentMatchIndex]) {
            searchMatches[currentMatchIndex].classList.remove('current');
        }
        currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;
        const target = searchMatches[currentMatchIndex];
        target.classList.add('current');
        target.scrollIntoView({ block: "center", inline: "nearest" });
        
        // Editor scroll update logic is handled by scrollIntoView but we need to sync backdrop
        codeEditor.scrollTop = codeBackdrop.scrollTop;
        codeEditor.scrollLeft = codeBackdrop.scrollLeft;

        // 修正: 現在位置を表示 (例: 1 / 5)
        statsEl.textContent = `${currentMatchIndex + 1} / ${searchMatches.length}`;
    }

    function doReplace() {
        const term = document.getElementById('searchInput').value;
        const rep = document.getElementById('replaceInput').value;
        if (!term) return;
        codeEditor.value = codeEditor.value.replace(term, rep);
        pushHistory(codeEditor.value);
        highlightSearch(); 
        updateLineNumbers();
        updateIndentGuides();
        const file = files.find(f => f.id === activeFileId);
        if(file) triggerAutoSave(file.dbId, codeEditor.value);
    }

    function doReplaceAll() {
        const term = document.getElementById('searchInput').value;
        const rep = document.getElementById('replaceInput').value;
        if (!term) return;
        codeEditor.value = codeEditor.value.replaceAll(term, rep);
        pushHistory(codeEditor.value);
        highlightSearch();
        updateLineNumbers();
        updateIndentGuides();
        const file = files.find(f => f.id === activeFileId);
        if(file) triggerAutoSave(file.dbId, codeEditor.value);
    }

    function downloadCode() {
        const format = document.getElementById('downloadFormat').value;
        const content = codeEditor.value;
        const bom = '\uFEFF'; 
        
        let mime = 'text/plain;charset=utf-8';
        if (format === 'html') mime = 'text/html;charset=utf-8';
        if (format === 'py') mime = 'text/x-python;charset=utf-8';

        const blob = new Blob([bom + content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const file = files.find(f => f.id === activeFileId);
        let filename = file ? file.name : `code.${format}`;
        
        if (!filename.toLowerCase().endsWith(`.${format}`)) {
            const parts = filename.split('.');
            if (parts.length > 1) parts.pop();
            filename = parts.join('.') + `.${format}`;
        }
        
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    // --- History & Trash System ---
    const historySidebar = document.getElementById('historySidebar');
    function toggleSidebar() {
        historySidebar.classList.toggle('open');
        if (historySidebar.classList.contains('open')) {
            renderSidebarContent();
        }
    }

    function switchSidebarTab(mode) {
        currentSidebarMode = mode;
        document.getElementById('tabHistory').className = `sidebar-tab ${mode === 'history' ? 'active' : ''}`;
        document.getElementById('tabTrash').className = `sidebar-tab ${mode === 'trash' ? 'active' : ''}`;
        document.getElementById('sidebarTitle').innerText = mode === 'history' ? '保存履歴' : 'ゴミ箱';
        
        const btn = document.getElementById('deleteAllBtn');
        btn.innerText = mode === 'history' ? '一括削除 (ゴミ箱へ)' : 'ゴミ箱を空にする';
        
        renderSidebarContent();
    }

    function getStorageData(key) {
        return JSON.parse(localStorage.getItem(key) || '[]');
    }

    function setStorageData(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    }

    function cleanupTrash() {
        let trash = getStorageData(TRASH_KEY);
        const now = Date.now();
        const oneWeek = 7 * 24 * 60 * 60 * 1000;
        const freshTrash = trash.filter(item => {
            if (!item.deletedAt) return false;
            return (now - item.deletedAt) < oneWeek;
        });
        if (freshTrash.length !== trash.length) {
            setStorageData(TRASH_KEY, freshTrash);
        }
    }

    function createInitialHistory(title, code) {
        const data = getStorageData(HISTORY_KEY);
        const newId = Date.now();
        const newItem = {
            id: newId,
            title: title,
            code: code,
            date: new Date().toISOString(),
            pinned: false
        };
        data.unshift(newItem);
        setStorageData(HISTORY_KEY, data);
        if (historySidebar.classList.contains('open')) renderSidebarContent();
        return newId;
    }

    function updateHistoryContent(dbId, newCode) {
        if(!dbId) return;
        let data = getStorageData(HISTORY_KEY);
        const item = data.find(i => i.id === dbId);
        if(item) {
            item.code = newCode;
            item.date = new Date().toISOString();
            data = data.filter(i => i.id !== dbId);
            data.unshift(item);
            setStorageData(HISTORY_KEY, data);
            if (historySidebar.classList.contains('open')) renderSidebarContent();
        }
    }

    function updateHistoryTitle(dbId, newTitle) {
        if(!dbId) return;
        let data = getStorageData(HISTORY_KEY);
        const item = data.find(i => i.id === dbId);
        if(item) {
            item.title = newTitle;
            setStorageData(HISTORY_KEY, data);
            if (historySidebar.classList.contains('open')) renderSidebarContent();
        }
    }
    
    // Rename triggered from Sidebar
    function renameHistoryItem(dbId) {
        const data = getStorageData(HISTORY_KEY);
        const item = data.find(i => i.id === dbId);
        if (!item) return;

        const newName = prompt("履歴のファイル名を変更:", item.title);
        if (newName && newName.trim() !== "") {
            // Extension Check
            if (!isValidExtension(newName)) {
                alert("拡張子は .html または .py のみ許可されています。");
                return;
            }

            // Update storage
            updateHistoryTitle(dbId, newName);
            // Check if this file is currently open in tabs
            const openFile = files.find(f => f.dbId === dbId);
            if (openFile) {
                openFile.name = newName;
                renderFileTabs();
                if (openFile.id === activeFileId) updateEditorMode(newName);
            }
        }
    }

    function softDeleteHistory(id) {
        if (!confirm("ゴミ箱に移動しますか？（1週間後に完全削除されます）")) return;
        let history = getStorageData(HISTORY_KEY);
        const item = history.find(i => i.id === id);
        if (item) {
            history = history.filter(i => i.id !== id);
            setStorageData(HISTORY_KEY, history);

            let trash = getStorageData(TRASH_KEY);
            item.deletedAt = Date.now(); 
            item.pinned = false; 
            trash.unshift(item);
            setStorageData(TRASH_KEY, trash);
            renderSidebarContent();
        }
    }
    
    function deleteAllItems() {
        const isTrash = currentSidebarMode === 'trash';
        const msg = isTrash ? "ゴミ箱を完全に空にしますか？この操作は取り消せません。" : "ピン留めされていない履歴をすべてゴミ箱へ移動しますか？";
        
        if (!confirm(msg)) return;
        if (isTrash) {
            setStorageData(TRASH_KEY, []);
        } else {
            let history = getStorageData(HISTORY_KEY);
            let trash = getStorageData(TRASH_KEY);
            
            const pinnedItems = history.filter(i => i.pinned);
            const itemsToDelete = history.filter(i => !i.pinned);
            if (itemsToDelete.length === 0) {
                alert("削除対象のアイテムがありません");
                return;
            }

            itemsToDelete.forEach(item => {
                item.deletedAt = Date.now();
                item.pinned = false;
            });
            setStorageData(HISTORY_KEY, pinnedItems);
            setStorageData(TRASH_KEY, [...itemsToDelete, ...trash]);
        }
        renderSidebarContent();
    }

    function restoreTrashItem(id) {
        let trash = getStorageData(TRASH_KEY);
        const item = trash.find(i => i.id === id);

        if (item) {
            trash = trash.filter(i => i.id !== id);
            setStorageData(TRASH_KEY, trash);

            let history = getStorageData(HISTORY_KEY);
            delete item.deletedAt; 
            history.unshift(item);
            setStorageData(HISTORY_KEY, history);
            renderSidebarContent();
        }
    }

    function permDeleteTrashItem(id) {
        if (!confirm("完全に削除しますか？この操作は取り消せません。")) return;
        let trash = getStorageData(TRASH_KEY);
        trash = trash.filter(i => i.id !== id);
        setStorageData(TRASH_KEY, trash);
        renderSidebarContent();
    }

    function togglePin(id) {
        let data = getStorageData(HISTORY_KEY);
        const item = data.find(i => i.id === id);
        if (item) {
            item.pinned = !item.pinned;
            setStorageData(HISTORY_KEY, data);
            renderSidebarContent();
        }
    }

    function loadHistoryItem(id, fromTrash = false) {
        const key = fromTrash ? TRASH_KEY : HISTORY_KEY;
        const data = getStorageData(key);
        const item = data.find(i => i.id === id);
        if (item) {
            if (fromTrash) {
                if(!confirm("ゴミ箱のアイテムです。エディタに読み込みますか？")) return;
            }
            addNewFile(item.title, item.code, item.id);
            if(window.innerWidth < 768) toggleSidebar();
        }
    }

    function renderSidebarContent() {
        const list = document.getElementById('historyList');
        const searchTerm = document.getElementById('historySearch').value.toLowerCase();
        const sortMode = document.getElementById('historySort').value;
        
        const isTrash = currentSidebarMode === 'trash';
        const storageKey = isTrash ? TRASH_KEY : HISTORY_KEY;
        let data = getStorageData(storageKey);

        if (searchTerm) {
            data = data.filter(item => item.title.toLowerCase().includes(searchTerm));
        }

        data.sort((a, b) => {
            if (!isTrash && a.pinned !== b.pinned) return b.pinned ? 1 : -1;
            if (sortMode === 'dateDesc') return new Date(b.date) - new Date(a.date);
            if (sortMode === 'dateAsc') return new Date(a.date) - new Date(b.date);
            if (sortMode === 'nameAsc') return a.title.localeCompare(b.title);
            return 0;
        });
        list.innerHTML = '';
        if (data.length === 0) {
            list.innerHTML = '<li style="padding:10px; color:#888; text-align:center;">アイテムがありません</li>';
            return;
        }

        data.forEach(item => {
            const li = document.createElement('li');
            li.className = `history-item ${item.pinned ? 'pinned' : ''}`;
            
            const dateStr = new Date(item.date).toLocaleString('ja-JP', { 
                year: 'numeric', month: '2-digit', day: '2-digit', hour:'2-digit', minute:'2-digit' 
            });

            // Icons
            const pinIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M16 9V4h1c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1h1v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/></svg>`;
            const trashIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
            const restoreIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M14 12c0-1.1-.9-2-2-2s-2 .9-2 2 .9 2 2 2 2-.9 2-2zm-2-9c-4.97 0-9 4.03-9 9H0l4 4 4-4H5c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.51 0-2.91-.49-4.06-1.3l-1.42 1.44C8.04 20.3 9.94 21 12 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>`;
            const deleteForeverIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
            const editIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;
            let buttonsHtml = '';
            if (isTrash) {
                buttonsHtml = `
                    <button class="icon-btn success" onclick="event.stopPropagation(); restoreTrashItem(${item.id})" title="復元">${restoreIcon}</button>
                    <button class="icon-btn danger" onclick="event.stopPropagation(); permDeleteTrashItem(${item.id})" title="完全削除">${deleteForeverIcon}</button>
                `;
            } else {
                buttonsHtml = `
                    <button class="icon-btn" onclick="event.stopPropagation(); renameHistoryItem(${item.id})" title="名前変更">${editIcon}</button>
                    <button class="icon-btn ${item.pinned ? 'active' : ''}" onclick="event.stopPropagation(); togglePin(${item.id})" title="ピン留め">${pinIcon}</button>
                    <button class="icon-btn danger" onclick="event.stopPropagation(); softDeleteHistory(${item.id})" title="削除（ゴミ箱へ）">${trashIcon}</button>
                `;
            }

            li.innerHTML = `
                <span class="history-title" onclick="loadHistoryItem(${item.id}, ${isTrash})">${escapeHtml(item.title)}</span>
                <div class="history-meta">
                    <span style="font-size:10px;">${isTrash ? '削除待機中' : dateStr}</span>
                    <div>${buttonsHtml}</div>
                </div>
            `;
            list.appendChild(li);
        });
    }

</script>
</body>
</html>
